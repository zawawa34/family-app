# 要件ドキュメント

## プロジェクト概要（入力）

ユーザーログイン機能の実装

## 機能概要
Family Appにユーザー認証とログイン機能を実装します。この機能により、ユーザーは安全にアカウントを作成し、ログインして家族専用の空間にアクセスできるようになります。

## 主要な要件
- 招待ベースのユーザー登録機能（メールアドレスとパスワード）
- 管理者による招待機能
- 初期管理者のseedデータによるセットアップ
- ユーザーの役割管理（管理者/一般ユーザー）
- ログイン/ログアウト機能
- パスワードの安全な保存（bcrypt使用）
- セッション管理（1年間の長期セッション維持）
- ログイン状態の確認
- 未ログインユーザーのリダイレクト処理

## 技術スタック
- Rails 8.0.3のAuthentication機能を活用
- bcrypt gemでパスワードの暗号化
- Railsのセッション管理
- Hotwire (Turbo + Stimulus) によるモダンなUI
- Tailwind CSSでスタイリング

## セキュリティ要件
- パスワードのハッシュ化（bcrypt）
- CSRF保護
- Strong Parameters使用
- セッションの安全な管理
- パスワードの最小文字数制限（8文字以上）

## テスト要件
- RSpecによる包括的なテストカバレッジ
- モデルのバリデーションテスト
- 認証機能の統合テスト
- Factory Botでテストデータ作成

---

## 要件

### 要件1: 招待ベースのユーザー登録機能
**目的:** 招待されたユーザーとして、招待リンクからアカウントを作成できるようにすることで、Family Appの機能にアクセスできるようにする

#### 受け入れ基準
1. WHEN ユーザーが招待リンクから登録フォームにアクセスした時 THEN 認証システムは招待トークンを検証してメールアドレスとパスワード入力フィールドを表示すること
2. IF 招待トークンが無効または期限切れの場合 THEN 認証システムは「招待リンクが無効または期限切れです」というエラーメッセージを表示すること
3. WHEN ユーザーが有効なメールアドレスとパスワード（8文字以上）を入力して登録を実行した時 THEN 認証システムは新しいユーザーアカウントを作成すること
4. WHEN ユーザーアカウントが作成された時 THEN 認証システムはパスワードをbcryptでハッシュ化して保存すること
5. WHEN 招待リンクから登録されたユーザーが作成された時 THEN 認証システムはユーザーの役割を「一般ユーザー」として設定すること
6. IF メールアドレスが既に登録されている場合 THEN 認証システムは「このメールアドレスは既に使用されています」というエラーメッセージを表示すること
7. IF パスワードが8文字未満の場合 THEN 認証システムは「パスワードは8文字以上である必要があります」というエラーメッセージを表示すること
8. IF メールアドレスの形式が不正な場合 THEN 認証システムは「有効なメールアドレスを入力してください」というエラーメッセージを表示すること
9. WHEN ユーザー登録が成功した時 THEN 認証システムはユーザーを自動的にログイン状態にしてホーム画面にリダイレクトすること
10. WHEN 招待リンクが使用された時 THEN 認証システムは招待を使用済みとしてマークして無効化すること

### 要件2: ログイン機能
**目的:** 登録済みユーザーとして、メールアドレスとパスワードでログインできるようにすることで、自分のアカウントにアクセスできるようにする

#### 受け入れ基準
1. WHEN ユーザーがログインフォームにアクセスした時 THEN 認証システムはメールアドレスとパスワード入力フィールドを表示すること
2. WHEN ユーザーが正しいメールアドレスとパスワードを入力してログインを実行した時 THEN 認証システムはユーザーを認証してセッションを作成すること
3. WHEN ログインが成功した時 THEN 認証システムはユーザーをホーム画面にリダイレクトすること
4. IF メールアドレスまたはパスワードが間違っている場合 THEN 認証システムは「メールアドレスまたはパスワードが正しくありません」というエラーメッセージを表示すること
5. IF ユーザーが既にログインしている状態でログインページにアクセスした場合 THEN 認証システムはユーザーをホーム画面にリダイレクトすること

### 要件3: ログアウト機能
**目的:** ログイン中のユーザーとして、ログアウトできるようにすることで、セキュアにセッションを終了できるようにする

#### 受け入れ基準
1. WHEN ログイン中のユーザーがログアウトを実行した時 THEN 認証システムは現在のセッションを破棄すること
2. WHEN ログアウトが完了した時 THEN 認証システムはユーザーをログインページにリダイレクトすること
3. WHEN ログアウト後 THEN 認証システムはユーザーを未認証状態として扱うこと

### 要件4: セッション管理と長期ログイン
**目的:** システムとして、ユーザーのログイン状態を安全に管理し、長期間ログイン状態を維持することで、適切なアクセス制御と利便性を実現する

#### 受け入れ基準
1. WHEN ユーザーがログインした時 THEN 認証システムはサーバー側にセッションを作成してセッションIDをクッキーに保存すること
2. WHEN ユーザーがログインした時 THEN 認証システムはセッションの有効期限を1年間に設定すること
3. WHILE ユーザーがログイン状態である間 認証システムはセッション情報を保持すること
4. WHEN ユーザーがリクエストを送信した時 THEN 認証システムはセッションIDを検証して現在のユーザーを特定すること
5. IF セッションが無効または期限切れ（1年経過）の場合 THEN 認証システムはユーザーを未認証状態として扱うこと
6. WHEN セッションが作成または破棄される時 THEN 認証システムはCSRF保護を適用すること
7. WHEN ユーザーがログインした時 THEN 認証システムはクッキーの有効期限を1年間に設定すること

### 要件5: アクセス制御
**目的:** システムとして、未ログインユーザーのアクセスを制限することで、認証が必要なコンテンツを保護する

#### 受け入れ基準
1. WHEN 未ログインユーザーが認証が必要なページにアクセスしようとした時 THEN 認証システムはユーザーをログインページにリダイレクトすること
2. WHEN リダイレクト後にログインが成功した時 THEN 認証システムはユーザーを元々アクセスしようとしていたページにリダイレクトすること
3. WHERE 公開ページ（ログイン、登録ページ等） 認証システムは認証なしでアクセスを許可すること
4. WHERE 認証が必要なページ 認証システムはログイン中のユーザーのみアクセスを許可すること
5. WHEN ログイン中のユーザーが認証が必要なページにアクセスした時 THEN 認証システムはページのコンテンツを表示すること

### 要件6: ユーザー識別とコンテキスト
**目的:** システムとして、現在ログイン中のユーザーを識別できるようにすることで、パーソナライズされた体験を提供する

#### 受け入れ基準
1. WHEN ログイン中のユーザーがページにアクセスした時 THEN 認証システムは現在のユーザー情報をアプリケーションコンテキストで利用可能にすること
2. WHERE 全てのページ 認証システムはログイン状態を確認するメソッドを提供すること
3. WHERE 全てのページ 認証システムは現在のユーザーを取得するメソッドを提供すること
4. IF ユーザーがログインしていない場合 THEN 認証システムは現在のユーザーとしてnilを返すこと

### 要件7: セキュリティとバリデーション
**目的:** システムとして、セキュリティのベストプラクティスに従うことで、ユーザーデータを保護する

#### 受け入れ基準
1. WHEN パスワードが保存される時 THEN 認証システムはbcryptアルゴリズムを使用してハッシュ化すること
2. WHEN ユーザー入力を処理する時 THEN 認証システムはStrong Parametersを使用して許可された属性のみを受け付けること
3. WHEN フォームが送信される時 THEN 認証システムはCSRFトークンを検証すること
4. WHERE データベース 認証システムは平文のパスワードを保存しないこと
5. WHEN パスワードが検証される時 THEN 認証システムはタイミング攻撃に対して安全な比較を行うこと
6. IF ユーザー登録またはログインが失敗した場合 THEN 認証システムは攻撃者に有用な情報を与えない一般的なエラーメッセージを表示すること

### 要件8: ユーザーインターフェース
**目的:** ユーザーとして、直感的で使いやすい認証UIを使用できるようにすることで、スムーズな体験を得る

#### 受け入れ基準
1. WHERE 登録フォームとログインフォーム 認証システムはTailwind CSSでスタイリングされた見やすいデザインを提供すること
2. WHEN フォームにバリデーションエラーがある時 THEN 認証システムは各フィールドの近くにエラーメッセージを表示すること
3. WHERE 全てのフォーム 認証システムはHotwire（Turbo）を使用してページ全体のリロードなしでフォーム送信を処理すること
4. WHEN フォームが送信中の時 THEN 認証システムはローディング状態を視覚的に表示すること
5. WHERE ナビゲーション 認証システムはログイン状態に応じて適切なリンク（ログイン/ログアウト）を表示すること

### 要件9: ユーザー役割管理
**目的:** システムとして、ユーザーの役割（管理者/一般ユーザー）を管理することで、適切な権限制御を実現する

#### 受け入れ基準
1. WHEN ユーザーアカウントが作成される時 THEN 認証システムはユーザーに役割を割り当てること
2. WHERE データベース 認証システムはユーザーの役割情報を保存すること
3. WHEN 招待リンクから登録されたユーザーが作成される時 THEN 認証システムは役割を「一般ユーザー」として設定すること
4. WHEN seedデータから作成されたユーザーが作成される時 THEN 認証システムは役割を「管理者」として設定すること
5. WHERE アプリケーション全体 認証システムは現在のユーザーの役割を確認するメソッドを提供すること
6. WHERE アプリケーション全体 認証システムはユーザーが管理者かどうかを確認するメソッドを提供すること

### 要件10: 招待機能
**目的:** 管理者として、新しいユーザーを招待できるようにすることで、Family Appのメンバーを管理する

#### 受け入れ基準
1. WHEN 管理者が招待リンク生成ページにアクセスした時 THEN 認証システムは招待リンク生成フォームを表示すること
2. IF 一般ユーザーが招待リンク生成ページにアクセスしようとした時 THEN 認証システムはアクセスを拒否してエラーメッセージを表示すること
3. WHEN 管理者が招待リンク生成を実行した時 THEN 認証システムはユニークな招待トークンを生成すること
4. WHEN 招待トークンが生成された時 THEN 認証システムは招待リンクを作成して管理者に表示すること
5. WHEN 招待が作成された時 THEN 認証システムは有効期限を7日間に設定すること
6. WHEN 招待が作成された時 THEN 認証システムは招待の状態を「未使用」として保存すること
7. WHERE 招待管理画面 認証システムは作成された招待の一覧（トークン、有効期限、状態）を表示すること
8. WHEN 招待が使用された時 THEN 認証システムは招待の状態を「使用済み」に更新すること
9. WHEN 招待の有効期限が過ぎた時 THEN 認証システムは招待を無効として扱うこと

### 要件11: 初期管理者のセットアップ
**目的:** システムとして、初期管理者アカウントを自動的にセットアップすることで、アプリケーションの初期設定を簡素化する

#### 受け入れ基準
1. WHEN データベースのseedコマンドが実行された時 THEN 認証システムは初期管理者アカウントを作成すること
2. WHEN 初期管理者が作成される時 THEN 認証システムは役割を「管理者」として設定すること
3. WHEN 初期管理者が作成される時 THEN 認証システムはseedファイルに記載された固定のメールアドレスとパスワードを使用すること
4. IF 初期管理者のメールアドレスが既に存在する場合 THEN 認証システムは新しいアカウントを作成せずにスキップすること
5. WHEN 初期管理者のパスワードが設定される時 THEN 認証システムはパスワードをbcryptでハッシュ化して保存すること
