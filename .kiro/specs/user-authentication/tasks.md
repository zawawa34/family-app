# 実装タスク

## 概要

本ドキュメントは、user-authentication機能の実装タスクを定義します。テスト駆動開発（TDD）のアプローチに従い、各タスクでテストを先に作成してから実装を行います。

## タスク一覧

- [ ] 1. プロジェクト基盤のセットアップと認証インフラの構築
  - Devise gemをプロジェクトに追加して基本設定を完了する
  - Deviseの初期化処理を実行して認証機能の基盤を構築する
  - bcryptを含む必要な依存関係をインストールする
  - Deviseの基本設定（セッション、CSRF、remember_me）を構成する
  - _要件: 7.1, 7.3, 4.1, 4.2_

- [ ] 2. ユーザー基本情報と役割管理機能の実装
- [ ] 2.1 ユーザー基本モデルのテストと実装
  - ユーザーの基本情報を管理するモデルのテストを作成する
  - 役割情報（管理者/一般ユーザー）を保存するデータ構造のテストを作成する
  - ユーザーの基本情報を管理する機能を実装する
  - データベーステーブルの作成とマイグレーションを実行する
  - _要件: 9.1, 9.2_

- [ ] 2.2 役割判定と権限確認機能のテストと実装
  - ユーザーが管理者かどうかを判定する機能のテストを作成する
  - ユーザーの役割を確認する機能のテストを作成する
  - 役割に基づいた権限確認ロジックを実装する
  - 管理者と一般ユーザーの区別を明確にする
  - _要件: 9.3, 9.4, 9.5, 9.6_

- [ ] 3. 認証情報管理機能の実装
- [ ] 3.1 認証情報モデルのテストと実装
  - メールアドレスとパスワードを管理するモデルのテストを作成する
  - メールアドレス形式の検証テストを作成する
  - パスワード最小長（8文字以上）の検証テストを作成する
  - メールアドレスの重複を防ぐ検証テストを作成する
  - 認証情報を安全に保存する機能を実装する
  - _要件: 1.3, 1.6, 1.7, 1.8, 7.1_

- [ ] 3.2 Devise統合と認証処理のテストと実装
  - パスワードのハッシュ化機能のテストを作成する
  - パスワード検証機能のテストを作成する
  - Deviseモジュールを認証情報モデルに統合する
  - bcryptを使用したパスワードの暗号化を確認する
  - タイミング攻撃に対して安全なパスワード比較を確認する
  - _要件: 1.4, 7.1, 7.4, 7.5_

- [ ] 4. 招待機能の実装
- [ ] 4.1 招待モデルのテストと実装
  - 招待情報を管理するモデルのテストを作成する
  - 招待トークンのユニーク性検証テストを作成する
  - 招待の有効期限（7日間）検証テストを作成する
  - 招待の状態（未使用/使用済み）管理テストを作成する
  - 招待情報を保存するデータベーステーブルを作成する
  - _要件: 10.3, 10.5, 10.6_

- [ ] 4.2 招待トークン生成とバリデーション機能のテストと実装
  - ランダムな招待トークンを生成する機能のテストを作成する
  - 招待トークンの有効性を判定する機能のテストを作成する
  - 期限切れ招待の検出機能のテストを作成する
  - 招待を使用済みにマークする機能のテストを作成する
  - 招待トークンの生成とバリデーションロジックを実装する
  - _要件: 10.3, 10.8, 10.9, 1.2, 1.10_

- [ ] 5. 認証フローの実装
- [ ] 5.1 ログイン機能のテストと実装
  - ログイン処理のリクエストテストを作成する
  - 正しい認証情報でのログイン成功テストを作成する
  - 誤った認証情報でのログイン失敗テストを作成する
  - セッション作成の動作テストを作成する
  - ログイン成功時のリダイレクト処理テストを作成する
  - ログイン機能を実装してセッションを確立する
  - _要件: 2.1, 2.2, 2.3, 2.4, 4.1_

- [ ] 5.2 ログアウト機能のテストと実装
  - ログアウト処理のリクエストテストを作成する
  - セッション破棄の動作テストを作成する
  - ログアウト後のリダイレクト処理テストを作成する
  - ログアウト後の認証状態確認テストを作成する
  - ログアウト機能を実装してセッションを終了する
  - _要件: 3.1, 3.2, 3.3_

- [ ] 5.3 長期セッション管理機能のテストと実装
  - 1年間の長期セッション維持のテストを作成する
  - remember_meトークンの生成と検証テストを作成する
  - クッキーの有効期限設定テストを作成する
  - セッション期限切れ時の動作テストを作成する
  - Deviseのrememberableモジュールを設定して長期セッションを実装する
  - _要件: 4.2, 4.3, 4.4, 4.5, 4.7_

- [ ] 6. 招待ベース登録フローの実装
- [ ] 6.1 登録処理のテストと実装
  - 招待トークン付き登録フォームのリクエストテストを作成する
  - ユーザーアカウント作成のテストを作成する
  - 認証情報の同時作成テストを作成する
  - 登録成功時の自動ログインテストを作成する
  - 登録成功時のホーム画面リダイレクトテストを作成する
  - 招待ベースの登録処理を実装する
  - _要件: 1.3, 1.4, 1.5, 1.9_

- [ ] 6.2 招待トークン検証フローのテストと実装
  - 招待トークンの検証処理テストを作成する
  - 無効な招待トークンでのエラー表示テストを作成する
  - 期限切れ招待トークンでのエラー表示テストを作成する
  - 招待使用後の状態更新テストを作成する
  - バリデーションエラー時のフォーム再表示テストを作成する
  - 招待トークン検証ロジックを実装する
  - _要件: 1.1, 1.2, 1.6, 1.7, 1.8, 1.10_

- [ ] 7. 招待管理機能の実装
- [ ] 7.1 招待作成機能のテストと実装
  - 招待リンク生成のリクエストテストを作成する
  - 招待情報の保存テストを作成する
  - 招待URLの生成テストを作成する
  - 招待一覧表示のテストを作成する
  - 管理者による招待作成機能を実装する
  - _要件: 10.1, 10.3, 10.4, 10.5, 10.6, 10.7_

- [ ] 7.2 管理者権限チェック機能のテストと実装
  - 管理者アクセス許可のテストを作成する
  - 一般ユーザーアクセス拒否のテストを作成する
  - 権限不足時のエラーメッセージ表示テストを作成する
  - 権限不足時のリダイレクト処理テストを作成する
  - 管理者権限チェックロジックを実装する
  - _要件: 10.1, 10.2_

- [ ] 8. アクセス制御の実装
- [ ] 8.1 認証フィルターのテストと実装
  - 未ログインユーザーのアクセス制限テストを作成する
  - ログイン済みユーザーのアクセス許可テストを作成する
  - 公開ページへの認証なしアクセステストを作成する
  - 認証必要ページへのアクセス制御テストを作成する
  - 全コントローラーに認証フィルターを適用する
  - _要件: 5.1, 5.3, 5.4, 5.5_

- [ ] 8.2 リダイレクト処理のテストと実装
  - 未ログインユーザーのログインページリダイレクトテストを作成する
  - ログイン後の元ページへのリダイレクトテストを作成する
  - 既ログインユーザーのログインページアクセス時リダイレクトテストを作成する
  - リダイレクトロジックを実装する
  - _要件: 5.1, 5.2, 2.5_

- [ ] 8.3 ユーザー識別コンテキストのテストと実装
  - 現在ログイン中のユーザー取得機能のテストを作成する
  - ログイン状態確認機能のテストを作成する
  - 未ログイン時のユーザー情報取得テストを作成する
  - ApplicationControllerでのcurrent_userメソッド実装テストを作成する
  - ユーザー識別機能を全コントローラーとビューで利用可能にする
  - _要件: 6.1, 6.2, 6.3, 6.4_

- [ ] 9. ユーザーインターフェースの実装
- [ ] 9.1 ログインフォームのテストと実装
  - ログインフォームの表示テストを作成する
  - メールアドレスとパスワード入力フィールドのテストを作成する
  - フォーム送信時のバリデーションエラー表示テストを作成する
  - Turboを使用したページリロードなし送信のテストを作成する
  - Tailwind CSSでスタイリングされたログインフォームを実装する
  - _要件: 8.1, 8.2, 8.3_

- [ ] 9.2 登録フォームのテストと実装
  - 招待トークン付き登録フォームの表示テストを作成する
  - メールアドレスとパスワード入力フィールドのテストを作成する
  - バリデーションエラー表示のテストを作成する
  - フォーム送信中のローディング状態表示テストを作成する
  - Tailwind CSSでスタイリングされた登録フォームを実装する
  - _要件: 8.1, 8.2, 8.3, 8.4_

- [ ] 9.3 招待管理画面のテストと実装
  - 招待リンク生成フォームの表示テストを作成する
  - 招待リンク一覧の表示テストを作成する
  - 招待の状態（未使用/使用済み/期限切れ）表示テストを作成する
  - 招待URL表示とコピー機能のテストを作成する
  - Tailwind CSSでスタイリングされた招待管理画面を実装する
  - _要件: 10.1, 10.4, 10.7, 8.1, 8.2_

- [ ] 9.4 ナビゲーションとログイン状態表示のテストと実装
  - ログイン状態に応じたナビゲーション表示テストを作成する
  - ログイン時のログアウトリンク表示テストを作成する
  - 未ログイン時のログインリンク表示テストを作成する
  - ログイン状態を反映したナビゲーションを実装する
  - _要件: 8.5_

- [ ] 10. ルーティングとセキュリティ設定の実装
- [ ] 10.1 ルーティング設定のテストと実装
  - Deviseルーティングの設定テストを作成する
  - 招待管理ルーティングの設定テストを作成する
  - カスタムコントローラーへのルーティングテストを作成する
  - RESTfulなルーティングを設定する
  - _要件: 全要件（ルーティング基盤）_

- [ ] 10.2 CSRF保護とStrong Parametersのテストと実装
  - CSRFトークン検証のテストを作成する
  - Strong Parametersによる入力制限テストを作成する
  - パラメータフィルタリングのテストを作成する
  - セキュリティ設定を全フォームに適用する
  - _要件: 7.2, 7.3, 7.6_

- [ ] 10.3 セキュリティ設定とログマスキングのテストと実装
  - パスワードのログマスキングテストを作成する
  - 招待トークンのログマスキングテストを作成する
  - セキュアCookie設定のテストを作成する
  - セキュリティベストプラクティスを適用する
  - _要件: 7.1, 7.4, 7.6, 4.6_

- [ ] 11. 初期データのセットアップ
- [ ] 11.1 初期管理者作成スクリプトのテストと実装
  - 初期管理者アカウント作成のテストを作成する
  - 管理者役割の設定テストを作成する
  - パスワードのハッシュ化確認テストを作成する
  - 既存管理者がある場合のスキップテストを作成する
  - seedスクリプトで初期管理者を作成する機能を実装する
  - _要件: 11.1, 11.2, 11.3, 11.4, 11.5_

- [ ] 12. 統合テストと動作確認
- [ ] 12.1 招待ベース登録E2Eフローのテストと実装
  - 管理者ログインから招待リンク生成までのE2Eテストを作成する
  - 招待リンクからユーザー登録までのE2Eテストを作成する
  - 登録後の自動ログインとリダイレクトのE2Eテストを作成する
  - E2Eテストが全て通過することを確認する
  - _要件: 10全体, 1全体_

- [ ] 12.2 認証フロー全体のE2Eテストと実装
  - ログインからログアウトまでのE2Eテストを作成する
  - アクセス制御の動作E2Eテストを作成する
  - セッション維持の動作E2Eテストを作成する
  - E2Eテストが全て通過することを確認する
  - _要件: 2全体, 3全体, 4全体, 5全体_

- [ ] 12.3 セキュリティ要件の検証テスト
  - パスワードハッシュ化の動作確認テストを作成する
  - CSRF保護の動作確認テストを作成する
  - セッションセキュリティの動作確認テストを作成する
  - 全セキュリティ要件が満たされていることを確認する
  - _要件: 7全体_

- [ ] 12.4 パフォーマンスとユーザビリティの確認
  - ログイン処理のレスポンスタイムを測定する
  - 招待トークン検証のレスポンスタイムを測定する
  - UIの直感性と使いやすさを確認する
  - 全ての要件が実装され動作することを確認する
  - _要件: 8全体, 全体の統合確認_

## 実装の進め方

### TDDサイクル
各タスクは以下のTDDサイクルに従って実装します：

1. **Red**: テストを先に書いて失敗を確認する
2. **Green**: テストをパスする最小限の実装を行う
3. **Refactor**: コードをリファクタリングして品質を向上させる

### テスト実行コマンド
```bash
# 全テスト実行
mise exec -- bundle exec rspec

# 特定のテストファイル実行
mise exec -- bundle exec rspec spec/models/user_spec.rb

# 特定のテストケース実行
mise exec -- bundle exec rspec spec/models/user_spec.rb:10
```

### 実装完了の定義
各タスクは以下の条件を満たした時点で完了とします：

1. 全てのテストが通過している
2. コードがRubocopのスタイルチェックをパスしている
3. 要件が満たされている
4. コードレビューが完了している（該当する場合）

### 要件カバレッジ
全11個の要件が上記タスクによってカバーされています。各タスクの詳細に要件番号が記載されており、実装時に参照してください。

## 注意事項

- 各タスクは1-3時間程度で完了できるサイズに設計されています
- タスクは依存関係を考慮して順序付けられています
- テストは常に実装の前に作成してください
- コミットは各メジャータスク（1, 2, 3...）または論理的なまとまりごとに行ってください
- 問題が発生した場合は、要件ドキュメントと設計ドキュメントを参照してください
