# 実装計画 - 買い物リスト機能

## 概要

買い物リスト機能を、テスト駆動開発（TDD）の原則に従って段階的に実装します。各タスクでは、まずテストを作成してから実装を行います。

---

## タスク一覧

- [ ] 1. データモデルとテスト基盤の構築
- [x] 1.1 買い物リストのデータ構造を実装
  - 買い物リスト（ShoppingList）と商品（ShoppingItem）のモデルを作成
  - 商品の基本属性（商品名、数量、メモ、購入店舗、カート追加状態、並び順）を定義
  - リストと商品の関連付けを設定（1対多の関係）
  - 将来の拡張に備えた所有者情報（owner_id）を含める
  - データベースマイグレーションの作成と実行
  - _Requirements: 14.1, 14.2_

- [x] 1.2 データモデルのバリデーションとスコープを実装
  - 商品名の必須バリデーションを実装
  - カート内商品と未カート商品を区別するスコープを実装
  - 特定店舗の商品を取得するスコープを実装（店舗未設定も含む）
  - カート追加・解除のヘルパーメソッドを実装
  - ファクトリー定義とモデルテストの作成
  - _Requirements: 2.3, 6.1, 6.2, 7.1_

- [x] 1.3 並び順管理の基盤を実装
  - positioning gem を統合
  - 商品の並び順（position）の自動管理を設定
  - 相対位置指定による並び替えロジックの実装
  - 並び順の整合性を保証するテストを作成
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [ ] 2. 買い物リスト表示とアクセス制御の実装
- [ ] 2.1 買い物リスト一覧画面の基本機能を実装
  - 認証済みユーザーのみがアクセス可能な買い物リスト画面を作成
  - デフォルトの買い物リストを表示する機能を実装
  - 商品を並び順に従って表示する機能を実装
  - 各商品の基本情報（商品名、数量、購入店舗、カート追加状態）を表示
  - 商品が存在しない場合の空状態メッセージを表示
  - モバイル最適化されたUIをTailwind CSSで実装
  - リクエストテストの作成
  - _Requirements: 1.1, 1.2, 10.1, 10.4, 10.5, 13.1, 13.2, 13.3_

- [ ] 2.2 カート内商品と未カート商品の視覚的区別を実装
  - カート内商品をグレーアウトまたは取り消し線で表示
  - カート追加状態を視覚的に明確に区別
  - 店舗未設定の商品を視覚的に区別して表示
  - レスポンシブ対応の確認
  - _Requirements: 6.2, 6.4, 8.5, 10.2_

- [ ] 3. 商品の基本操作（追加・編集・削除）の実装
- [ ] 3.1 商品追加機能を実装
  - 画面上部に常に表示される商品追加フォームを実装
  - 商品名のみで即座に商品を追加できる機能を実装
  - Turbo Frameによる画面遷移なしの追加処理を実装
  - 商品追加時にフォームを自動クリア
  - 新しい商品をリストの末尾に配置
  - バリデーションエラー時のエラー表示を実装
  - リクエストテストとシステムテストの作成
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 12.1, 12.2_

- [ ] 3.2 商品編集機能を実装
  - 商品をタップして編集フォームを表示する機能を実装
  - 商品名、数量、メモ、購入店舗の編集フォームを実装
  - Turbo Frameによる編集フォームのインライン表示を実装
  - 編集内容の保存とリスト表示の更新を実装
  - 商品名の空バリデーションとエラー表示を実装
  - 編集キャンセル機能を実装
  - リクエストテストの作成
  - _Requirements: 3.1, 3.2, 3.4, 3.5, 3.6, 12.1_

- [ ] 3.3 商品削除機能を実装
  - 個別商品の削除ボタンを実装
  - 削除確認ダイアログを実装
  - Turbo Streamによる削除処理を実装
  - 削除キャンセル機能を実装
  - リクエストテストの作成
  - _Requirements: 5.1, 5.2, 5.3, 12.1_

- [ ] 4. 商品の並び替え機能（ドラッグ&ドロップ）の実装
- [ ] 4.1 SortableJSを使ったドラッグ&ドロップUIを実装
  - SortableJS を Importmap 経由で読み込み
  - Stimulus コントローラーで並び替えUIを実装
  - 長押しで商品をドラッグ可能な状態にする機能を実装
  - ドラッグ中のリアルタイムプレビュー表示を実装
  - ドロップ時にサーバーに並び順を送信する機能を実装
  - 相対位置指定（前の要素の後ろに配置）のロジックを実装
  - エラー時の元の位置への復元機能を実装
  - システムテストの作成
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 12.3_

- [ ] 5. カート機能（商品をカートに入れる/一括削除）の実装
- [ ] 5.1 商品をカートに入れる機能を実装
  - 商品をタップしてカート追加状態を切り替える機能を実装
  - カート追加時に picked_at タイムスタンプを記録
  - Turbo Streamによるリアルタイム更新を実装
  - カート追加状態の即座のサーバー保存を実装
  - カート内商品の視覚的な区別（グレーアウト）を実装
  - リクエストテストの作成
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 12.1_

- [ ] 5.2 カート内商品の一括削除機能を実装
  - カート内商品が存在する場合に「カート内商品を削除」ボタンを表示
  - カート内商品が存在しない場合はボタンを非表示または無効化
  - 一括削除の確認ダイアログを実装
  - すべてのカート内商品を一括削除する機能を実装
  - 削除件数を通知メッセージで表示
  - Turbo Streamによる削除処理を実装
  - リクエストテストの作成
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5, 12.1_

- [ ] 6. 店舗フィルタリングと入力補完の実装
- [ ] 6.1 購入店舗によるフィルタリング機能を実装
  - フィルタボタンをタップして店舗選択メニューを表示
  - 「すべて」オプションと登録済み店舗名リストを表示
  - 特定店舗選択時に該当商品と店舗未設定商品を表示
  - 「すべて」選択時にすべての商品を表示
  - 店舗未設定商品を視覚的に区別して表示
  - 現在のフィルタ条件を画面上に明示
  - リクエストテストの作成
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6_

- [ ] 6.2 店舗名オートコンプリート機能を実装
  - 購入店舗フィールドでの入力補完候補を実装
  - 過去に入力された店舗名から候補を生成
  - 入力内容に部分一致する候補を表示
  - 使用頻度順に最大10件の候補を表示
  - Stimulus コントローラーでオートコンプリートUIを実装
  - 候補タップ時の自動入力機能を実装
  - 新しい店舗名の履歴への追加を実装
  - リクエストテストの作成
  - _Requirements: 3.3, 9.1, 9.2, 9.3, 9.4, 9.5_

- [ ] 7. レスポンシブ対応とエラーハンドリングの実装
- [ ] 7.1 モバイル最適化とタッチ操作を実装
  - スマートフォン画面サイズでの最適化レイアウトを実装
  - 最小44x44pxのタップターゲットサイズを確保
  - タップ時の視覚的フィードバック（ハイライト・アニメーション）を実装
  - ローディングインジケーターを実装
  - Tailwind CSS標準クラスと8ptグリッドシステムに準拠
  - デザインシステムのアクセシビリティチェックリスト（11項目）を確認
  - システムテストの作成
  - _Requirements: 1.4, 11.1, 11.2, 11.3, 11.4, 11.5_

- [ ] 7.2 エラーハンドリングと通知機能を実装
  - バリデーションエラーのユーザーフレンドリーな表示を実装
  - サーバー通信エラー時のエラーメッセージ表示を実装
  - データベース操作失敗時の再試行促進メッセージを実装
  - 未認証ユーザーのログイン画面へのリダイレクトを確認
  - 成功時の通知メッセージ（フラッシュメッセージ）を実装
  - グローバルエラーハンドリングの実装
  - リクエストテストの作成
  - _Requirements: 12.1, 12.2, 12.3, 12.4, 13.1, 13.2_

- [ ] 8. 統合テストとセキュリティの最終確認
- [ ] 8.1 E2Eテストと全体統合を実装
  - 商品追加から購入完了までの完全なフローをテスト
  - ドラッグ&ドロップによる並び替えのE2Eテストを実装
  - 複数ユーザーでの同時操作の動作確認
  - 各種エラーケースのE2Eテストを実装
  - パフォーマンステスト（大量商品データでの表示速度）を実施
  - セキュリティの最終確認（アクセス制御、Strong Parameters、CSRF対策）
  - システムテストの作成
  - _Requirements: 13.1, 13.2, 13.3, 13.4, All requirements_

---

## 実装の進め方

### TDDサイクルの遵守
各タスクで以下のサイクルを実施：
1. **Red**: テストを先に書き、失敗を確認
2. **Green**: 最小限の実装でテストを通過
3. **Refactor**: コードを整理・改善

### テストの種類
- **モデルテスト**: バリデーション、スコープ、メソッドの動作確認
- **リクエストテスト**: コントローラーのHTTPリクエスト/レスポンス確認
- **システムテスト**: エンドツーエンドのブラウザ操作確認

### 段階的な実装
- 各タスクは独立して完結し、前のタスクの成果物を活用
- データモデル → コントローラー → ビュー → フロントエンドの順で構築
- 常に動作する状態を維持しながら機能を追加

### 設計ドキュメントの活用
- 実装の詳細は `.kiro/specs/shopping-list/design.md` を参照
- データモデル、コントローラー、ビューの具体的な実装は設計書に記載
